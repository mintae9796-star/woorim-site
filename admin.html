<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>우림비닐하우스 · Admin</title>
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
  <style>
    :root{
      --brand:#5A7F71; --brand-ink:#35564a;
      --bg:#ffffff; --text:#1f2937; --muted:#6b7280;
      --card:#ffffff; --line:#e6eae7;
      --danger:#ef4444; --ok:#16a34a; --warn:#f59e0b;
      --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.08);
      --container:1120px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:"Pretendard",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;height:auto;border-radius:8px}
    .container{max-width:var(--container);margin:0 auto;padding:0 16px}

    /* Header */
    header{position:sticky;top:0;z-index:40;background:rgba(255,255,255,.95);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--line)}
    .nav{display:flex;align-items:center;justify-content:space-between;min-height:56px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900}
    .logo-badge{width:28px;height:28px;border-radius:10px;background:var(--brand);display:grid;place-items:center;color:#fff;font-size:.9rem}

    .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;padding:10px 14px;border-radius:12px;background:var(--brand);color:#fff;font-weight:800;border:0;cursor:pointer;transition:.18s}
    .btn:hover{filter:brightness(.96)}
    .btn.ghost{background:#fff;color:var(--brand);border:2px solid var(--brand)}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.mono{background:#fff;border:1px solid var(--line);color:var(--text);font-weight:700}

    /* Layout */
    .row{display:grid;gap:12px}
    @media(min-width:720px){ .row.cols-2{grid-template-columns:1fr 1fr} .row.cols-3{grid-template-columns:1fr 1fr 1fr} }

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    input, textarea, select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;font:inherit;outline:none}
    textarea{min-height:110px;resize:vertical}
    input:focus,textarea:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 4px rgba(90,127,113,.14)}

    .tabs{display:flex;flex-wrap:wrap;gap:8px;margin:16px 0}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);cursor:pointer}
    .tab.active{background:var(--brand);color:#fff;border-color:transparent}

    .list{display:grid;gap:10px}
    .item{display:grid;gap:10px;grid-template-columns:1fr auto;align-items:center;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
    .item h4{margin:0;font-size:16px}
    .muted{color:var(--muted);font-size:12px}

    /* Gate/App */
    .gate, .app{padding:20px}
    .gate .card{max-width:520px;margin:20px auto}

    /* Inline editor (drawer) */
    .editbox{display:none;margin-top:10px;border-top:1px dashed var(--line);padding-top:10px}
    .item.editing .editbox{display:block}

    /* Modal (confirm delete) */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:60}
    .overlay.show{display:flex}
    .modal{background:#fff;border-radius:16px;border:1px solid var(--line);padding:18px;max-width:420px;width:92%}

    /* Toast (bottom) */
    .toast{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);z-index:80;display:grid;gap:8px;max-width:92%;width:680px}
    .toast .t{display:flex;gap:10px;align-items:flex-start;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;box-shadow:var(--shadow);animation:pop .2s ease}
    .t.ok{border-color:#DCF3E3}
    .t.err{border-color:#FADADB}
    .t.warn{border-color:#FEF1C7}
    @keyframes pop{from{transform:translate(-50%,10px);opacity:0}to{transform:translate(-50%,0);opacity:1}}

    /* Small */
    small.help{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <span class="logo-badge">GH</span> 우림비닐하우스 · Admin
      </div>
      <div>
        <button id="btnLogout" class="btn ghost" style="display:none">로그아웃</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- 로그인 -->
    <section id="gate" class="gate">
      <div class="card">
        <h2 style="margin:0 0 8px">관리자 로그인</h2>
        <p class="muted" style="margin:0 0 12px">이메일/비밀번호만 허용 · <b>role=admin</b> 사용자만 접근</p>
        <div class="row">
          <input id="loginEmail" type="email" placeholder="이메일" autocomplete="username">
          <input id="loginPw" type="password" placeholder="비밀번호" autocomplete="current-password">
          <button id="btnLogin" class="btn">로그인</button>
          <small class="help">※ 익명/소셜 로그인은 차단됩니다.</small>
        </div>
      </div>
    </section>

    <!-- 앱 -->
    <section id="app" class="app" style="display:none">
      <div class="tabs">
        <div class="tab active" data-tab="cases">시공사례</div>
        <div class="tab" data-tab="reviews">고객 후기</div>
        <div class="tab" data-tab="faqs">FAQ</div>
        <div class="tab" data-tab="settings">설정(사업자 정보)</div>
      </div>

      <!-- 시공사례 -->
      <div id="panel-cases" class="card">
        <h3 style="margin:0 0 10px">시공사례 관리</h3>
        <div class="row cols-3">
          <input id="caseTitle" placeholder="제목">
          <input id="caseSubtitle" placeholder="부제목(선택)">
          <input id="caseOrder" type="number" placeholder="표시순서(작을수록 위)">
        </div>
        <div class="row cols-2" style="margin-top:10px">
          <input id="caseImage" placeholder="대표 이미지 URL">
          <input id="caseGallery" placeholder="갤러리 이미지 URL들(쉼표)">
        </div>
        <label style="margin:8px 0;display:inline-flex;gap:8px;align-items:center">
          <input id="casePublished" type="checkbox" checked> 공개
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnAddCase" class="btn">추가</button>
          <button id="btnResetCase" class="btn mono">입력 초기화</button>
        </div>
        <div style="height:10px"></div>
        <div class="list" id="caseList"></div>
      </div>

      <!-- 후기 -->
      <div id="panel-reviews" class="card" style="display:none">
        <h3 style="margin:0 0 10px">고객 후기 관리</h3>
        <div class="row cols-3">
          <input id="revTitle" placeholder="후기 제목">
          <input id="revAuthor" placeholder="작성자 (선택)">
          <select id="revRating">
            <option value="5">★ 5</option><option value="4">★ 4</option>
            <option value="3">★ 3</option><option value="2">★ 2</option>
            <option value="1">★ 1</option>
          </select>
        </div>
        <div class="row cols-2" style="margin-top:10px">
          <input id="revImage" placeholder="이미지 URL(선택)">
          <input id="revOrder" type="number" placeholder="표시순서(작을수록 위)">
        </div>
        <textarea id="revBody" placeholder="후기 내용(HTML 가능, script 금지)" style="margin-top:10px"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button id="btnAddReview" class="btn">추가</button>
          <button id="btnResetReview" class="btn mono">입력 초기화</button>
        </div>
        <div style="height:10px"></div>
        <div class="list" id="revList"></div>
      </div>

      <!-- FAQ -->
      <div id="panel-faqs" class="card" style="display:none">
        <h3 style="margin:0 0 10px">FAQ 관리</h3>
        <div class="row cols-3">
          <input id="faqQ" placeholder="질문">
          <input id="faqOrder" type="number" placeholder="표시순서(작을수록 위)">
        </div>
        <textarea id="faqA" placeholder="답변(HTML 가능, script 금지)" style="margin-top:10px"></textarea>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button id="btnAddFaq" class="btn">추가</button>
          <button id="btnResetFaq" class="btn mono">입력 초기화</button>
        </div>
        <div style="height:10px"></div>
        <div class="list" id="faqList"></div>
      </div>

      <!-- 설정(사업자 정보만) -->
      <div id="panel-settings" class="card" style="display:none">
        <h3 style="margin:0 0 10px">사업자 정보</h3>
        <div class="row cols-3">
          <input id="bizName" placeholder="상호">
          <input id="bizOwner" placeholder="대표자">
          <input id="bizRegNo" placeholder="사업자등록번호">
        </div>
        <div class="row cols-2" style="margin-top:10px">
          <input id="bizAddr" placeholder="주소">
          <input id="bizEtc" placeholder="기타(통신판매업번호 등)">
        </div>
        <div style="margin-top:10px">
          <button id="btnSaveBiz" class="btn">저장</button>
        </div>
        <small class="help" style="display:block;margin-top:8px">
          ※ index.html 푸터에 반영됩니다. (settings/main 문서의 businessInfo)
        </small>
      </div>
    </section>
  </div>

  <!-- Delete confirm modal -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3 style="margin:0 0 10px">정말 삭제할까요?</h3>
      <p class="muted" style="margin:0 0 12px">삭제 후 복구할 수 없습니다.</p>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn mono" id="btnCancelDel">취소</button>
        <button class="btn danger" id="btnOkDel">삭제</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, setDoc, updateDoc, deleteDoc, doc,
      getDoc, getDocs, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    /* ===== Firebase config (운영) ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyANNpMdqbnQYPPgyCrR9LyBeM5MD7w77jM",
      authDomain: "woorim-site.firebaseapp.com",
      projectId: "woorim-site",
      storageBucket: "woorim-site.appspot.com",
      messagingSenderId: "1048438590071",
      appId: "1:1048438590071:web:653737eef80b205e57d472"
    };
    const app = getApps()[0] || initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ===== helpers ===== */
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const toastBox = $('#toast');
    function toast(msg, type='ok'){
      const el = document.createElement('div');
      el.className = `t ${type}`;
      el.innerHTML = `<div>${msg}</div>`;
      toastBox.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .3s'; setTimeout(()=>el.remove(), 320); }, 2600);
    }
    function sanitizeHtml(html=''){
      return (html||'').replace(/<script/gi,'&lt;script');
    }
    function toArrayCSV(v){ return (v||'').split(',').map(s=>s.trim()).filter(Boolean); }

    /* ===== Tabs ===== */
    $$('.tab').forEach(t=>t.addEventListener('click', ()=>{
      $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
      const name = t.dataset.tab;
      ['cases','reviews','faqs','settings'].forEach(n=> $('#panel-'+n).style.display = (n===name?'block':'none'));
    }));

    /* ===== Auth gate ===== */
  // ✅ 관리자 확인 함수 (클레임 → roles/{uid} → rolesByEmail/{email})
  async function isAdmin(user){
    try{
      // 강제 새 토큰 발급(클레임 최신화)
      const token = await user.getIdTokenResult(true);
      if (token?.claims?.role === 'admin') return true;
    }catch(e){ /* ignore */ }

    try{
      const byUid = await getDoc(doc(db, 'roles', user.uid));
      if (byUid.exists() && (byUid.data()?.role === 'admin')) return true;
    }catch(e){ /* ignore */ }

    try{
      if (user.email){
        const byEmail = await getDoc(doc(db, 'rolesByEmail', user.email));
        if (byEmail.exists() && (byEmail.data()?.role === 'admin')) return true;
      }
    }catch(e){ /* ignore */ }

    return false;
  }

  // 로그인 버튼
  $('#btnLogin').addEventListener('click', async ()=>{
    const email = $('#loginEmail').value.trim();
    const pw = $('#loginPw').value.trim();
    if(!email || !pw){ toast('이메일/비밀번호를 입력하세요.', 'warn'); return; }
    try{
      const cr = await signInWithEmailAndPassword(auth, email, pw);
      if(await isAdmin(cr.user)){
        toast('관리자 로그인됨', 'ok');
      }else{
        await signOut(auth);
        toast('관리자 권한이 없습니다. (roles 컬렉션 또는 클레임 확인)', 'err');
      }
    }catch(e){
      toast('로그인 실패: ' + (e?.message||e), 'err');
    }
  });

  // 상태 변경
  onAuthStateChanged(auth, async (user)=>{
    const gate = $('#gate'), appPanel = $('#app'), btnLogout = $('#btnLogout');
    if(!user){
      gate.style.display='block'; appPanel.style.display='none'; btnLogout.style.display='none';
      return;
    }
    if(await isAdmin(user)){
      gate.style.display='none'; appPanel.style.display='block'; btnLogout.style.display='inline-flex';
      // 여기서 데이터 로드 호출 (기존 함수들 유지)
      Promise.all([renderCases(), renderReviews(), renderFaqs(), loadBiz()]).catch(()=>{});
    }else{
      await signOut(auth);
      toast('관리자 권한이 없습니다. (roles 컬렉션 또는 클레임 확인)', 'err');
    }
    btnLogout.onclick = async ()=>{ await signOut(auth); toast('로그아웃되었습니다.', 'ok'); };
  });
    /* ===== 시공사례 CRUD ===== */
    $('#btnAddCase').addEventListener('click', async ()=>{
      const payload = {
        title: $('#caseTitle').value.trim(),
        subtitle: $('#caseSubtitle').value.trim(),
        imageUrl: $('#caseImage').value.trim(),
        gallery: toArrayCSV($('#caseGallery').value),
        order: Number($('#caseOrder').value||999),
        published: $('#casePublished').checked,
        createdAt: Date.now()
      };
      if(!payload.title || !payload.imageUrl){ toast('제목/대표이미지를 입력하세요.', 'warn'); return; }
      await addDoc(collection(db,'cases'), payload);
      resetCaseForm(); toast('시공사례가 추가되었습니다.', 'ok');
      await renderCases();
    });
    $('#btnResetCase').addEventListener('click', resetCaseForm);
    function resetCaseForm(){
      ['#caseTitle','#caseSubtitle','#caseImage','#caseGallery','#caseOrder'].forEach(id=> $(id).value='');
      $('#casePublished').checked = true;
    }

    async function renderCases(){
      const list = $('#caseList'); list.innerHTML='';
      const snap = await getDocs(query(collection(db,'cases'), orderBy('order','asc')));
      snap.forEach(docu=>{
        const d = docu.data();
        const item = document.createElement('div'); item.className='item';
        item.innerHTML = `
          <div>
            <h4>${d.title||''}</h4>
            <div class="muted">${d.subtitle||''} · 순서:${d.order} · 공개:${d.published?'예':'아니오'}</div>
            <div class="editbox">
              <div class="row cols-3" style="margin-top:6px">
                <input value="${d.title||''}"    data-f="title">
                <input value="${d.subtitle||''}" data-f="subtitle">
                <input value="${d.order||999}"   data-f="order" type="number">
              </div>
              <div class="row cols-2" style="margin-top:6px">
                <input value="${d.imageUrl||''}" data-f="imageUrl" placeholder="대표 이미지 URL">
                <input value="${(d.gallery||[]).join(',')}" data-f="gallery" placeholder="갤러리(쉼표)">
              </div>
              <label style="margin-top:6px;display:inline-flex;gap:8px;align-items:center">
                <input type="checkbox" data-f="published" ${d.published?'checked':''}> 공개
              </label>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn mono" data-act="cancel">취소</button>
                <button class="btn" data-act="save">저장</button>
              </div>
            </div>
          </div>
          <div>
            <button class="btn ghost" data-act="edit">수정</button>
            <button class="btn danger" data-act="del">삭제</button>
          </div>`;
        list.appendChild(item);

        const ref = doc(db,'cases', docu.id);
        const toggle = ()=> item.classList.toggle('editing');
        item.querySelector('[data-act="edit"]').onclick = ()=> toggle();
        item.querySelector('[data-act="cancel"]').onclick = ()=>{ item.classList.remove('editing'); toast('취소되었습니다.', 'warn'); };

        item.querySelector('[data-act="save"]').onclick = async ()=>{
          const get = (sel)=> item.querySelector(`[data-f="${sel}"]`);
          const v = {
            title: get('title').value.trim(),
            subtitle: get('subtitle').value.trim(),
            imageUrl: get('imageUrl').value.trim(),
            gallery: toArrayCSV(get('gallery').value),
            order: Number(get('order').value||999),
            published: item.querySelector('[data-f="published"]').checked,
          };
          await updateDoc(ref, v);
          item.classList.remove('editing');
          toast('저장되었습니다.', 'ok');
          await renderCases();
        };

        // deletion
        item.querySelector('[data-act="del"]').onclick = ()=> confirmDelete(async ()=>{
          await deleteDoc(ref);
          toast('삭제되었습니다.', 'ok');
          await renderCases();
        });
      });
    }

    /* ===== 리뷰 CRUD ===== */
    $('#btnAddReview').addEventListener('click', async ()=>{
      const payload = {
        title: $('#revTitle').value.trim() || '고객 후기',
        author: $('#revAuthor').value.trim() || '고객',
        rating: Number($('#revRating').value||5),
        order: Number($('#revOrder').value||999),
        imageUrl: $('#revImage').value.trim(),
        bodyHtml: sanitizeHtml($('#revBody').value||''),
        createdAt: Date.now()
      };
      await addDoc(collection(db,'reviews'), payload);
      ['#revTitle','#revAuthor','#revOrder','#revImage','#revBody'].forEach(i=>$(i).value='');
      $('#revRating').value='5';
      toast('후기가 추가되었습니다.', 'ok');
      await renderReviews();
    });
    $('#btnResetReview').addEventListener('click', ()=>{ ['#revTitle','#revAuthor','#revOrder','#revImage','#revBody'].forEach(i=>$(i).value=''); $('#revRating').value='5'; });

    async function renderReviews(){
      const list = $('#revList'); list.innerHTML='';
      const snap = await getDocs(query(collection(db,'reviews'), orderBy('order','asc')));
      snap.forEach(docu=>{
        const d = docu.data();
        const item = document.createElement('div'); item.className='item';
        item.innerHTML = `
          <div>
            <h4>${d.title||'고객 후기'}</h4>
            <div class="muted">작성자:${d.author||'고객'} · 평점:${d.rating||0} · 순서:${d.order||999}</div>
            <div class="editbox">
              <div class="row cols-3" style="margin-top:6px">
                <input value="${d.title||''}"  data-f="title" placeholder="제목">
                <input value="${d.author||''}" data-f="author" placeholder="작성자">
                <input value="${d.order||999}" data-f="order" type="number">
              </div>
              <div class="row cols-2" style="margin-top:6px">
                <select data-f="rating">
                  ${[5,4,3,2,1].map(n=>`<option value="${n}" ${Number(d.rating||0)===n?'selected':''}>★ ${n}</option>`).join('')}
                </select>
                <input value="${d.imageUrl||''}" data-f="imageUrl" placeholder="이미지 URL">
              </div>
              <textarea data-f="bodyHtml" style="margin-top:6px" placeholder="후기 내용(HTML 가능, script 금지)">${d.bodyHtml||d.bodyHTML||''}</textarea>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn mono" data-act="cancel">취소</button>
                <button class="btn" data-act="save">저장</button>
              </div>
            </div>
          </div>
          <div>
            <button class="btn ghost" data-act="edit">수정</button>
            <button class="btn danger" data-act="del">삭제</button>
          </div>`;
        list.appendChild(item);

        const ref = doc(db,'reviews', docu.id);
        const toggle = ()=> item.classList.toggle('editing');
        item.querySelector('[data-act="edit"]').onclick = ()=> toggle();
        item.querySelector('[data-act="cancel"]').onclick = ()=>{ item.classList.remove('editing'); toast('취소되었습니다.', 'warn'); };
        item.querySelector('[data-act="save"]').onclick = async ()=>{
          const get = (f)=> item.querySelector(`[data-f="${f}"]`);
          const v = {
            title: get('title').value.trim() || '고객 후기',
            author: get('author').value.trim() || '고객',
            rating: Number(get('rating').value||5),
            order: Number(get('order').value||999),
            imageUrl: get('imageUrl').value.trim(),
            bodyHtml: sanitizeHtml(get('bodyHtml').value||'')
          };
          await updateDoc(ref, v);
          item.classList.remove('editing');
          toast('저장되었습니다.', 'ok');
          await renderReviews();
        };
        item.querySelector('[data-act="del"]').onclick = ()=> confirmDelete(async ()=>{
          await deleteDoc(ref);
          toast('삭제되었습니다.', 'ok');
          await renderReviews();
        });
      });
    }

    /* ===== FAQ CRUD ===== */
    $('#btnAddFaq').addEventListener('click', async ()=>{
      const payload = {
        q: $('#faqQ').value.trim(),
        aHtml: sanitizeHtml($('#faqA').value||''),
        order: Number($('#faqOrder').value||999)
      };
      if(!payload.q){ toast('질문을 입력하세요.', 'warn'); return; }
      await addDoc(collection(db,'faqs'), payload);
      ['#faqQ','#faqA','#faqOrder'].forEach(i=>$(i).value='');
      toast('FAQ가 추가되었습니다.', 'ok');
      await renderFaqs();
    });
    $('#btnResetFaq').addEventListener('click', ()=>{ ['#faqQ','#faqA','#faqOrder'].forEach(i=>$(i).value=''); });

    async function renderFaqs(){
      const list = $('#faqList'); list.innerHTML='';
      const snap = await getDocs(query(collection(db,'faqs'), orderBy('order','asc')));
      snap.forEach(docu=>{
        const d = docu.data();
        const item = document.createElement('div'); item.className='item';
        item.innerHTML = `
          <div>
            <h4>${d.q||''}</h4>
            <div class="muted">순서:${d.order||999}</div>
            <div class="editbox">
              <div class="row cols-3" style="margin-top:6px">
                <input value="${d.q||''}" data-f="q" placeholder="질문">
                <input value="${d.order||999}" data-f="order" type="number">
              </div>
              <textarea data-f="aHtml" style="margin-top:6px" placeholder="답변(HTML 가능, script 금지)">${d.aHtml||d.aHTML||''}</textarea>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn mono" data-act="cancel">취소</button>
                <button class="btn" data-act="save">저장</button>
              </div>
            </div>
          </div>
          <div>
            <button class="btn ghost" data-act="edit">수정</button>
            <button class="btn danger" data-act="del">삭제</button>
          </div>`;
        list.appendChild(item);

        const ref = doc(db,'faqs', docu.id);
        const toggle = ()=> item.classList.toggle('editing');
        item.querySelector('[data-act="edit"]').onclick = ()=> toggle();
        item.querySelector('[data-act="cancel"]').onclick = ()=>{ item.classList.remove('editing'); toast('취소되었습니다.', 'warn'); };
        item.querySelector('[data-act="save"]').onclick = async ()=>{
          const get = (f)=> item.querySelector(`[data-f="${f}"]`);
          const v = {
            q: get('q').value.trim(),
            order: Number(get('order').value||999),
            aHtml: sanitizeHtml(get('aHtml').value||'')
          };
          await updateDoc(ref, v);
          item.classList.remove('editing');
          toast('저장되었습니다.', 'ok');
          await renderFaqs();
        };
        item.querySelector('[data-act="del"]').onclick = ()=> confirmDelete(async ()=>{
          await deleteDoc(ref);
          toast('삭제되었습니다.', 'ok');
          await renderFaqs();
        });
      });
    }

    /* ===== 설정: 사업자 정보 ===== */
    async function loadBiz(){
      const s = await getDoc(doc(db,'settings','main'));
      const v = s.exists()? s.data() : {};
      const biz = v.businessInfo || {};
      $('#bizName').value  = biz.name||'';
      $('#bizOwner').value = biz.owner||'';
      $('#bizRegNo').value = biz.regNo||'';
      $('#bizAddr').value  = biz.addr||'';
      $('#bizEtc').value   = biz.etc||'';
    }
    $('#btnSaveBiz').addEventListener('click', async ()=>{
      const payload = {
        businessInfo:{
          name:  $('#bizName').value.trim(),
          owner: $('#bizOwner').value.trim(),
          regNo: $('#bizRegNo').value.trim(),
          addr:  $('#bizAddr').value.trim(),
          etc:   $('#bizEtc').value.trim()
        }
      };
      await setDoc(doc(db,'settings','main'), payload, {merge:true});
      toast('사업자 정보가 저장되었습니다.', 'ok');
    });

    /* ===== 삭제 확인 모달 ===== */
    const overlay = $('#overlay'); let _confirmFn=null;
    function confirmDelete(fn){ _confirmFn = fn; overlay.classList.add('show'); }
    $('#btnCancelDel').onclick = ()=>{ overlay.classList.remove('show'); toast('취소되었습니다.', 'warn'); _confirmFn=null; };
    $('#btnOkDel').onclick = async ()=>{ overlay.classList.remove('show'); if(_confirmFn){ await _confirmFn(); _confirmFn=null; } };

  </script>
</body>
</html>
